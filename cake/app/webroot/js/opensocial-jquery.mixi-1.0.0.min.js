/*
 * OpenSocial jQuery mixi Platform 1.0.0
 * http://code.google.com/p/opensocial-jquery/
 *
 * Copyright(C) 2009 Nakajiman Software Inc.
 * http://nakajiman.lrlab.to/
 *
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 */
(function(){jQuery.extend(jQuery.container,{mixi:true,sandbox:false});jQuery("html").addClass("mixi");jQuery.extend({_view:jQuery.view,view:function(d,g){var e=/^(?:\w+:)?\/\/([^\/?#]+)/;if(!e.test(d||"")){return jQuery._view(d,g)}var f=e.exec(d)[1];g=jQuery.param(g||{});if(g){d+=(d.match(/\?/)?"&":"?")+g}if(/\.mixi(\.co)?\.jp$/.test("."+f)){window.open(d,"_top")}else{mixi.util.requestExternalNavigateTo(d)}},invite:function(e,f){var d=$.deferred();if(jQuery.isFunction(e)){f=e;e=null}var g=function(h){if(h.hadError()){setTimeout(function(){d.fail(h.getErrorCode())},0)}else{var i=h.getData()["recipientIds"];if(f){f(i)}d.call(i)}};if(e=="@classmates"){mixi.classmates.requestShareApp(g)}else{opensocial.requestShareApp("VIEWER_FRIENDS",null,g)}return d}});var a={ok:200,notImplemented:501,unauthorized:401,forbidden:403,badRequest:400,internalError:500,limitExceeded:417};var b=jQuery.ajaxSettings.xhr;var c=function(){this.initialize()};jQuery.extend(c.prototype,jQuery._xhr.prototype,{send:function(){var e=this,f=e.url,d={"@me":"VIEWER","@viewer":"VIEWER","@owner":"OWNER"};var g=f.split("/")[2];if(d[g]){g=d[g]}var h=opensocial.newDataRequest();h.add(mixi.newFetchCommunityRequest(g),"data");h.send(function(j){e.readyState=4;if(j.hadError()){var k=j.get("data")||new opensocial.ResponseItem(null,null,"internalError");e.status=a[k.getErrorCode()];e.statusText=k.getErrorCode()}else{var k=j.get("data");var l=k.getData();var i=jQuery.map(l.asArray(),function(m){var o=m.getField(mixi.Community.Field.ID).split("/");var n="http://mixi.jp/view_community.pl?"+jQuery.param({id:o[1]});return{id:o[1],userId:o[0],url:n,name:m.getField(mixi.Community.Field.TITLE),thumbnailUrl:m.getField(mixi.Community.Field.THUMBNAIL_URL)}});i.totalResults=l.getTotalSize();e.status=a.ok;e.statusText="ok";e.responseData=i}})}});b.addRoute("GET","/communities/",c);var c=function(){this.initialize()};jQuery.extend(c.prototype,jQuery._xhr.prototype,{send:function(){var e=this,f=e.url,d={"@me":"VIEWER","@viewer":"VIEWER"},i={"01":"\u5C0F\u5B66\u6821","02":"\u4E2D\u5B66\u6821","03":"\u9AD8\u7B49\u5B66\u6821","04":"\u5927\u5B66","05":"\u77ED\u671F\u5927\u5B66","06":"\u5927\u5B66\u9662","07":"\u5C02\u9580\u5B66\u6821\u30FB\u4E88\u5099\u6821","08":"\u9AD8\u7B49\u5C02\u9580\u5B66\u6821","09":"\u4E2D\u7B49\u6559\u80B2\u5B66\u6821","10":"\u305D\u306E\u4ED6\u306E\u6559\u80B2\u6A5F\u95A2"};var g=f.split("/")[2];if(d[g]){g=d[g]}if(g=="@selected"){mixi.classmates.requestFetchSchool(mixi.classmates.SchoolSelectType.LIST,function(k){e.readyState=4;if(k.hadError()){e.status=a[k.getErrorCode()];e.statusText=k.getErrorCode()}else{var j=k.getData().school;var l=[{token:j.getField(mixi.classmates.SchoolField.TOKEN),divisionId:j.getField(mixi.classmates.SchoolField.DIVISION),division:i[j.getField(mixi.classmates.SchoolField.DIVISION)]}];l.totalResults=l.length;e.status=a.ok;e.statusText="ok";e.responseData=l}})}else{var h=opensocial.newDataRequest();h.add(mixi.classmates.newFetchSchoolsRequest(g),"data");h.send(function(j){e.readyState=4;if(j.hadError()){var k=j.get("data")||new opensocial.ResponseItem(null,null,"internalError");e.status=a[k.getErrorCode()];e.statusText=k.getErrorCode()}else{var k=j.get("data");var m=k.getData();var l=jQuery.map(m.asArray(),function(n){return{token:n.getField(mixi.classmates.SchoolField.TOKEN),divisionId:n.getField(mixi.classmates.SchoolField.DIVISION),division:i[n.getField(mixi.classmates.SchoolField.DIVISION)]}});l.totalResults=m.getTotalSize();e.status=a.ok;e.statusText="ok";e.responseData=l}})}}});b.addRoute("GET","/schools/",c)})();